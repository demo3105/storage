name: Deploy JSON to QA Storage

on:
  workflow_dispatch:  # Allows manual trigger from GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3


    - name: Login to Azure using Service Principal
      run: |
        az login --service-principal \
          --username "${{ secrets.AZURE_CLIENT_ID }}" \
          --password "${{ secrets.AZURE_CLIENT_SECRET }}" \
          --tenant "${{ secrets.AZURE_TENANT_ID }}"
    

    - name: Upload JSON files to QA Storage
      run: |
        # Define your environment-specific variables
        RESOURCE_GROUP="demostorage"
        STORAGE_ACCOUNT="qademostorage123"
        CONTAINER_NAME="qadbcontroldb"
        SOURCE_DIR="storage folder"  # Path to your JSON files in repo

        # Get storage account key
        ACCOUNT_KEY=$(az storage account keys list \
          --resource-group "demostorage" \
          --account-name "qademostorage123" \
          --query "[0].value" -o tsv)

        # Upload all JSON files from the source directory
        find "$SOURCE_DIR" -name "*.json" | while read file; do
          az storage blob upload \
            --account-name "qademostorage123" \
            --account-key "$ACCOUNT_KEY" \
            --container-name "qadbcontroldb" \
            --file "$file" \
            --name "$(basename "$file")" 
        done
